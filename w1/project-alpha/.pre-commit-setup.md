# Pre-commit 和 GitHub Actions 设置指南

## Pre-commit 设置

### 1. 安装 pre-commit

```bash
# 使用 pip 安装
pip install pre-commit

# 或使用 uv（推荐）
uv pip install pre-commit
```

### 2. 安装 Git hooks

```bash
# 在项目根目录执行
pre-commit install
```

### 3. 手动运行 pre-commit

```bash
# 检查所有文件
pre-commit run --all-files

# 只检查暂存的文件（默认）
pre-commit run
```

### 4. 更新 pre-commit hooks

```bash
pre-commit autoupdate
```

## 配置的工具

### Python 工具

- **black**: 代码格式化（行长度 100）
- **isort**: 导入排序（兼容 black）
- **flake8**: 代码检查（行长度 100，忽略 E203, W503）

### TypeScript/JavaScript 工具

- **prettier**: 代码格式化
- **eslint**: 代码检查

### 其他工具

- **yaml-lint**: YAML 文件检查
- **markdownlint**: Markdown 文件检查
- **hadolint**: Dockerfile 检查
- **通用检查**: 尾随空格、文件结尾、大文件检查等

## GitHub Actions

### CI Workflow (`.github/workflows/ci.yml`)

包含以下任务：

1. **Pre-commit Checks**: 运行所有 pre-commit hooks
2. **Backend Tests**:
   - 设置 PostgreSQL 服务
   - 运行数据库迁移
   - 代码格式检查（black, isort, flake8）
   - 类型检查（mypy，可选）
3. **Frontend Tests**:
   - 代码检查（eslint）
   - 类型检查（TypeScript）
   - 构建测试
4. **Docker Build**: 构建 Docker 镜像验证

### Pre-commit Workflow (`.github/workflows/pre-commit.yml`)

专门用于运行 pre-commit 检查，在 PR 和 push 时自动触发。

## 使用说明

### 本地开发

1. **首次设置**:

   ```bash
   # 安装 pre-commit
   pip install pre-commit
   # 或
   uv pip install pre-commit
   
   # 安装 hooks
   pre-commit install
   ```

2. **提交代码时**:
   - Pre-commit 会自动运行
   - 如果有错误，会自动修复或提示
   - 修复后需要重新 add 和 commit

3. **手动运行**:

   ```bash
   # 检查所有文件
   pre-commit run --all-files
   
   # 只检查暂存文件
   pre-commit run
   ```

### 跳过 pre-commit（不推荐）

```bash
# 跳过所有 hooks
git commit --no-verify

# 跳过特定 hook
SKIP=flake8 git commit
```

## 配置文件说明

### `.pre-commit-config.yaml`

主配置文件，定义了所有 pre-commit hooks。

### `backend/pyproject.toml`

包含 Python 工具的配置：

- `[tool.black]`: Black 格式化配置
- `[tool.isort]`: isort 导入排序配置
- `[tool.flake8]`: Flake8 检查配置
- `[tool.mypy]`: MyPy 类型检查配置

### `frontend/.eslintrc.cjs`

ESLint 配置文件，定义了 TypeScript/React 代码检查规则。

### `frontend/.prettierrc.json`

Prettier 配置文件，定义了代码格式化规则。

## 常见问题

### Q: Pre-commit 运行太慢？

A: Pre-commit 会缓存 hooks，首次运行较慢，后续会更快。也可以只检查特定文件：

```bash
pre-commit run --files backend/app/main.py
```

### Q: 如何更新 hooks 版本？

A: 运行 `pre-commit autoupdate` 会自动更新到最新版本。

### Q: 如何添加新的 hook？

A: 编辑 `.pre-commit-config.yaml`，添加新的 repo 和 hook 配置。

### Q: GitHub Actions 失败怎么办？

A: 查看 Actions 日志，通常是因为代码格式或 lint 错误。在本地运行 `pre-commit run --all-files` 修复问题。

## 最佳实践

1. **提交前运行检查**: 使用 `pre-commit run --all-files` 确保代码质量
2. **保持 hooks 更新**: 定期运行 `pre-commit autoupdate`
3. **不要跳过 hooks**: 除非有特殊原因，不要使用 `--no-verify`
4. **修复而不是忽略**: 遇到 lint 错误时，修复代码而不是忽略规则
