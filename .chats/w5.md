# Instructions


## deep search

主要的需求是在Python下面创建一个Postgres的mcp：用户可以给特定自然语言描述的查询的需求，然后mcp server 根据结果来返回一个SQL或者返回这个查询的结果。mcp的服务器在启动的时候，应该读取它都有哪些可以访问的数据库，并且缓存这些数据库的schema：了解每一个数据库下面都有哪些 table/view/types/index 等等，然后根据这些信息以及用户的输入去调用LLM来生成 SQL。之后mcp server应该来校验这个sql只允许查询的语句然后测试这个sql确保它能够执行并且返回有意义的结果：这里也可以把用户的输入生成的sql以及返回的结果的一部分调用LLM来确认这样可以确保它的结果是不是有意义。最后根据用户的输入是返回SQL还是返回SQL查询之后的结果来返回相应的内容,LL使用阿里的通义千问模型，DASHSCOPE_API_KEY 在环境变量中。帮我研究下这个需求如果使用Python来实现的话那应该用哪些库，为什么用这些库.

## 构建 mcp server

主要的需求是在Python下面创建一个Postgres的mcp：用户可以给特定自然语言描述的查询的需求，然后mcp server 根据结果来返回一个SQL或者返回这个查询的结果。mcp的服务器在启动的时候，应该读取它都有哪些可以访问的数据库，并且缓存这些数据库的schema：了解每一个数据库下面都有哪些 table/view/types/index 等等，然后根据这些信息以及用户的输入去调用LLM来生成 SQL。之后mcp server应该来校验这个sql只允许查询的语句然后测试这个sql确保它能够执行并且返回有意义的结果：这里也可以把用户的输入生成的sql以及返回的结果的一部分调用LLM来确认这样可以确保它的结果是不是有意义。最后根据用户的输入是返回SQL还是返回SQL查询之后的结果来返回相应的内容,LL使用阿里的通义千问模型，DASHSCOPE_API_KEY 在环境变量中.根据这些需求帮我构建一个详细的需求文档，先不要著急去做设计，等我review完这个需求文档之后呢我们再来讨论设计，文档放在 ./specs/w5/0001-pg-mcp-prd.md 文件中。


SQLGlot替换sqlparse

接口只需要query即可，其他意义不大

## commit/review

commit code; 然后，接口目前只需要 query 即可，其它意义不大；另外调用 codex review skill 让 codex review 这个需求文档，并更新


## 构建PGMCP的设计文档

根据./specs/w5/0001-pg-mcp-prd.md 文件，技术栈使用FastMCP、SQLGlot、OpenAi SDK、asyncpg、pydantic，构建一个详细的设计文档，放在 ./specs/w5/0002-pg-mcp-design.md 文件中。think ultra hard。


设计文档中不要有代码的描述，只需要描述功能和设计即可。

使用 mermaid 绘制架构，设计，组件，流程等图表并详细说明


## deep search(Gemini)

帮我深度研究SQL Glot，了解它的设计理念和支持的sql范围。

## codex review design document

使用 sub agent 调用 codex review skill 让 codex review ./specs/w5/0002-pg-mcp-design.md 文件。之后仔细阅读 review 的结果，思考是否合理，然后相应地更新 ./specs/w5/0002-pg-mcp-design.md 文件。


## 规则

为 ./w5/pg-mcp 生成 AGENTS.md. 要求： 代码要符合 python best practices / idiomatic python, 符合SOLID/DRY/YAGNI/KISS/etc.原则,代码质量和测试质量要高，性能要好。


## impl plan

根据 ./specs/w5/0002-pg-mcp-design.md 文件，构建实现计划，放在 ./specs/w5/0003-pg-mcp-impl-plan.md 文件中。think ultra hard。
