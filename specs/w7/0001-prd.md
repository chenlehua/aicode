# GenSlides 产品需求文档 (PRD)

## 概述

GenSlides 是一个本地运行的单页应用，使用 Google Gemini API 根据文本内容生成图片幻灯片，并支持走马灯形式的全屏播放。所有生成的图片将遵循用户选择的统一视觉风格。

## 目标用户

需要快速生成视觉统一的幻灯片演示的本地用户。

## 技术栈

| 层级 | 技术选型 |
|------|----------|
| 后端 | Python + FastAPI + Google Gemini SDK |
| 前端 | TypeScript + Tailwind CSS + Zustand |
| 存储 | 本地文件系统（无数据库） |
| API | Gemini API Key |

## 功能需求

### 1. 核心功能

#### 1.1 风格初始化

- **首次打开检测**: 当用户首次打开某个 slides 项目时，系统检测是否已设置风格图片
- **风格设置弹窗**: 如果没有风格图片，弹出 Popup 引导用户设置：
  1. 用户输入一段描述期望视觉风格的文字（如"简约商务风格，蓝色调"）
  2. 系统调用 Gemini API 根据描述生成 2 张候选风格图片
  3. 用户从 2 张图片中选择一张作为该 slides 的统一风格
  4. 选中的风格图片和 prompt 一并保存到 `outline.yml` 并存储到本地
- **风格参考**: 后续生成新图片时，将风格图片（style.image）作为参考一并传给 Gemini API，确保视觉风格统一
- **风格修改**: 用户可在设置中重新选择或生成新的风格图片，修改风格后不影响已生成的图片，仅对后续新生成的图片生效

#### 1.2 Slides 管理

- **唯一标识**: 每个 slide 拥有唯一的 `sid`（slide id），与其子图片关联
- **单击预览**: 用户单击侧边栏某个 slide，在右侧预览区显示对应的图片
- **双击编辑**: 用户双击侧边栏某个 slide，可以编辑该 slide 的文字内容；文字内容变更后自动触发新图片生成
- **拖拽排序**: 用户选中并拖拽侧边栏的 slide，可以改变 slides 的顺序
- **新建 Slide**: 用户点击某个 slide 后设定锚点，按回车键在该 slide 下方创建新的 slide

#### 1.3 图片生成

- **文本驱动**: 图片根据当前 slide 的文字内容自动生成
- **风格一致**: 生成时参考用户选择的风格图片，保持视觉统一
- **缓存机制**: 图片保存在路径 `<slug>/images/<sid>/<文字blake3hash>.jpg`
  - 如果左侧选中的 slide 文字 blake3 hash 一致的图片存在，则直接展示
  - 如果不存在，在主图片区域下方显示「生成图片」按钮，用户点击后触发新图片生成
- **并行处理**: 图片生成支持并行处理，slides 之间互不影响
- **实时更新**: 当最新图片完成时，需触发更新通知

#### 1.4 图片预览

- **主图片展示**: 右侧预览区显示当前选中 slide 对应的图片
- **缩略图列表**: 主图片区域底部显示该 slide 所有历史生成图片的缩略图
- **缩略图切换**: 用户点击缩略图可切换主预览区显示的图片

#### 1.5 播放功能

- **全屏播放**: 点击「播放」按钮，从当前选中的 slide 开始全屏播放
- **走马灯模式**: slides 以走马灯（carousel）形式连续播放
- **键盘控制**:
  - 左右箭头键：切换上一张/下一张 slide
  - ESC 键：退出全屏播放

#### 1.6 成本展示

- **实时统计**: 在界面上展示当前 slides 的总体生成成本
- **费用明细**: 帮助用户了解 Gemini API 调用费用，包括已生成图片数量和预估费用

### 2. 页面布局

#### 2.1 主界面

```
+---------------------------------------------------------------------------------+
| Logo: GenSlides  [slides题头输入框]  [风格: 简约商务 ⚙]  [成本: $0.12] [播放]     |
+---------------------------------------------------------------------------------+
|                      |                                                          |
|   slides 整体        |                                                          |
|   +-----------+      |      +---------------------------+                       |
|   | Slide 1   |      |      |                           |                       |
|   +-----------+      |      |      主图片预览区域         |                       |
|   +-----------+      |      |                           |                       |
|   | Slide 2   |      |      +---------------------------+                       |
|   +-----------+      |           [生成图片] (无匹配时显示)                        |
|   ...                |      +---+ +---+ +---+ +---+                             |
|                      |      |缩略图1|缩略图2|缩略图3|...                          |
|                      |      +---+ +---+ +---+ +---+                             |
+---------------------------------------------------------------------------------+
```

说明：
- **slides题头输入框**: 用于编辑当前 slides 的标题
- **风格 ⚙**: 点击齿轮图标可打开风格设置，重新选择或生成新风格图片

#### 2.2 风格设置弹窗（首次打开时）

```
+------------------------------------------+
|           设置幻灯片视觉风格               |
+------------------------------------------+
|                                          |
|  请描述您期望的视觉风格：                   |
|  +------------------------------------+  |
|  | 简约商务风格，蓝色调，现代感         |  |
|  +------------------------------------+  |
|                                          |
|              [生成风格图片]               |
|                                          |
|  +---------------+  +---------------+    |
|  |               |  |               |    |
|  |   风格图片 1   |  |   风格图片 2   |    |
|  |               |  |               |    |
|  +---------------+  +---------------+    |
|      [选择]            [选择]            |
|                                          |
+------------------------------------------+
```

### 3. URL 路由

- 访问 `http://localhost:3003/<slug>` 对应 `./slides/<slug>` 目录下的 slides
- 示例: `http://localhost:3003/hello-world` → `./slides/hello-world/`

## 数据存储

### 目录结构

```
./slides/
├── <slug>/
│   ├── outline.yml              # 包含所有文本信息、风格设置等
│   ├── style/
│   │   └── style.jpg            # 用户选择的风格参考图片
│   └── images/
│       └── <sid>/
│           └── <blake3hash>.jpg # 某个slide下的图片
```

### outline.yml 示例

```yaml
title: "演示标题"
created_at: "2024-01-15T10:30:00Z"
updated_at: "2024-01-15T14:20:00Z"

# 风格设置
style:
  prompt: "简约商务风格，蓝色调，现代感"
  image: "style/style.jpg"
  created_at: "2024-01-15T10:30:00Z"

# 幻灯片列表
slides:
  - sid: "slide-001"
    content: "第一张幻灯片的文字内容"
    created_at: "2024-01-15T10:30:00Z"
    updated_at: "2024-01-15T10:30:00Z"
  - sid: "slide-002"
    content: "第二张幻灯片的文字内容"
    created_at: "2024-01-15T11:00:00Z"
    updated_at: "2024-01-15T14:20:00Z"
```

## 目标 (Goals)

1. **视觉风格统一**: 通过风格图片参考，确保所有生成的 slides 具有一致的视觉风格
2. **流畅的生成体验**: 支持流畅的 slides 生成，找到最优方案
3. **并行处理**: 图片生成应可并行处理，slides 之间互不影响；当最新图片完成时，需触发更新通知
4. **成本控制**: 注意展示最新 slides 的总成本

## 非目标 (Non-Goals)

1. **不支持导出为 pptx**: 当前版本不考虑 PowerPoint 导出功能
2. **无数据库**: 不使用数据库存储
3. **无权限管理**: 整个 app 运行在本地，不需要用户认证和权限管理

## API 设计（初步）

### 后端 API

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/slides/{slug}` | 获取指定 slug 的所有 slides 信息（含风格设置） |
| PUT | `/api/slides/{slug}/title` | 更新 slides 的标题 |
| POST | `/api/slides/{slug}` | 创建新的 slide |
| PUT | `/api/slides/{slug}/{sid}` | 更新指定 slide 的内容 |
| PUT | `/api/slides/{slug}/reorder` | 更新 slides 的顺序 |
| DELETE | `/api/slides/{slug}/{sid}` | 删除指定 slide |
| POST | `/api/slides/{slug}/{sid}/generate` | 触发图片生成（将风格图片作为参考传给 Gemini API） |
| GET | `/api/slides/{slug}/{sid}/images` | 获取 slide 的所有图片（含缩略图） |
| GET | `/api/slides/{slug}/cost` | 获取当前 slides 的总体生成成本 |
| POST | `/api/slides/{slug}/style/generate` | 根据 prompt 生成 2 张候选风格图片 |
| PUT | `/api/slides/{slug}/style` | 保存用户选择的风格（prompt + image） |
| GET | `/api/slides/{slug}/style` | 获取当前风格设置 |

### WebSocket

- `/ws/slides/{slug}` - 实时推送图片生成进度和完成通知

## 技术实现要点

1. **Gemini API 集成**: 使用 Google Gemini SDK 进行图片生成，需配置 Gemini API Key
2. **风格参考生成**: 调用 Gemini API 生成 slide 图片时，将风格图片（style.image）作为参考图片一并传入 API，确保生成图片风格一致
3. **Blake3 哈希**: 使用 blake3 算法对 slide 文字内容进行哈希，作为图片文件名的一部分
4. **图片缓存**: 基于 blake3 hash 实现图片缓存，避免重复生成
5. **异步生成**: 使用 FastAPI 的异步特性，支持多个 slide 图片的并行生成
6. **状态管理**: 前端使用 Zustand 管理 slides 状态，支持实时更新
7. **风格独立性**: 修改风格后不影响已生成的图片，仅对后续新生成的图片生效

## 配置

### 环境变量

```bash
GEMINI_API_KEY=your_gemini_api_key_here
```

## 里程碑

### MVP (最小可行产品)

- [ ] 风格初始化弹窗
- [ ] 风格设置（重新选择或生成新风格）
- [ ] 基础 slides 列表展示
- [ ] Slides 题头编辑
- [ ] Slide 内容编辑
- [ ] 单张图片生成（带风格参考）
- [ ] 图片预览（含缩略图切换）
- [ ] 全屏播放（走马灯 + 键盘控制）
- [ ] 成本展示

### 后续迭代

- [ ] 批量图片生成优化
- [ ] 生成进度实时展示
